// Script de v√©rification compl√®te de toutes les APIs
const https = require('https');

console.log('üîç V√©rification compl√®te de toutes les APIs');
console.log('==========================================');

// Fonction pour tester une route avec gestion d'erreur d√©taill√©e
const testAPI = async (name, method, url, body = null, expectedStatus = 200) => {
  try {
    const options = {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      }
    };

    if (body) {
      options.body = JSON.stringify(body);
    }

    const response = await fetch(url, options);
    const data = await response.json();
    
    const isSuccess = response.status === expectedStatus;
    const status = isSuccess ? '‚úÖ' : '‚ùå';
    
    console.log(`${status} ${method} ${name} - ${response.status} (attendu: ${expectedStatus})`);
    
    if (!isSuccess) {
      console.log(`   Erreur: ${data.error || 'Unknown error'}`);
      if (data.details) {
        console.log(`   D√©tails: ${data.details}`);
      }
    } else if (Array.isArray(data)) {
      console.log(`   üìä ${data.length} √©l√©ments trouv√©s`);
    } else if (data.success !== undefined) {
      console.log(`   üìä Succ√®s: ${data.success}`);
    } else {
      console.log(`   üìä Donn√©es re√ßues`);
    }
    
    return { 
      success: isSuccess, 
      status: response.status, 
      data, 
      expectedStatus,
      method,
      name 
    };
  } catch (error) {
    console.log(`‚ùå ${method} ${name} - Erreur r√©seau: ${error.message}`);
    return { success: false, error: error.message, method, name };
  }
};

// Test complet de toutes les APIs
const testAllAPIs = async () => {
  console.log('\nüìä Test complet des APIs :');
  console.log('==========================');

  const results = {};

  // 1. API Users
  console.log('\nüë• API Users:');
  results.users = {
    get: await testAPI('Users GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/users'),
    post: await testAPI('Users POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/users', {
      name: 'Test User API Check',
      email: `test-api-check-${Date.now()}@example.com`,
      role: 'reader',
      password: 'testpass123'
    }, 201)
  };

  // 2. API Processes
  console.log('\nüìã API Processes:');
  results.processes = {
    get: await testAPI('Processes GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/processes'),
    post: await testAPI('Processes POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/processes', {
      name: `Test Process API Check ${Date.now()}`,
      description: 'Test de cr√©ation de processus',
      category: 'Test',
      status: 'draft',
      tags: ['test', 'api-check']
    }, 201)
  };

  // 3. API Documents
  console.log('\nüìÑ API Documents:');
  results.documents = {
    get: await testAPI('Documents GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/documents'),
    post: await testAPI('Documents POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/documents', {
      name: `Test Document API Check ${Date.now()}.pdf`,
      type: 'pdf',
      size: 1024000,
      version: '1.0',
      url: '#'
    }, 201)
  };

  // 4. API Entities
  console.log('\nüè¢ API Entities:');
  results.entities = {
    get: await testAPI('Entities GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/entities'),
    post: await testAPI('Entities POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/entities', {
      name: `Test Entity API Check ${Date.now()}`,
      type: 'department',
      description: 'Test de cr√©ation d\'entit√©'
    }, 201)
  };

  // 5. API Categories
  console.log('\nüè∑Ô∏è API Categories:');
  results.categories = {
    get: await testAPI('Categories GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/categories'),
    post: await testAPI('Categories POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/categories', {
      name: `Test Category API Check ${Date.now()}`,
      description: 'Test de cr√©ation de cat√©gorie',
      type: 'process',
      color: '#FF5733'
    }, 201)
  };

  // 6. API Statuses
  console.log('\nüìä API Statuses:');
  results.statuses = {
    get: await testAPI('Statuses GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/statuses'),
    post: await testAPI('Statuses POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/statuses', {
      name: `Test Status API Check ${Date.now()}`,
      description: 'Test de cr√©ation de statut',
      type: 'process',
      color: '#00FF00',
      order: 99
    }, 201)
  };

  // 7. API Reports
  console.log('\nüìà API Reports:');
  results.reports = {
    get: await testAPI('Reports GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/reports'),
    post: await testAPI('Reports POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/reports', {
      name: `Test Report API Check ${Date.now()}`,
      description: 'Test de cr√©ation de rapport',
      type: 'processes',
      filters: { category: 'test' },
      data: { test: 'data' },
      isPublic: false,
      tags: ['test']
    }, 201)
  };

  // 8. API Access Logs
  console.log('\nüìù API Access Logs:');
  results.accessLogs = {
    get: await testAPI('Access Logs GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/access-logs'),
    post: await testAPI('Access Logs POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/access-logs', {
      userId: 1,
      userName: 'Test User',
      action: 'test',
      resource: 'test',
      resourceId: `test-${Date.now()}`,
      success: true,
      details: 'Test de cr√©ation de log'
    }, 201)
  };

  // 9. API Process-Entities
  console.log('\nüîó API Process-Entities:');
  results.processEntities = {
    get: await testAPI('Process-Entities GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/process-entities'),
    post: await testAPI('Process-Entities POST', 'POST', 'https://v0-process-management-platform.vercel.app/api/process-entities', {
      processId: 1,
      entityId: 1
    }, 201)
  };

  // 10. API Permissions
  console.log('\nüîê API Permissions:');
  results.permissions = {
    get: await testAPI('Permissions GET', 'GET', 'https://v0-process-management-platform.vercel.app/api/permissions'),
    matrix: await testAPI('Permissions Matrix', 'GET', 'https://v0-process-management-platform.vercel.app/api/permissions?action=matrix')
  };

  return results;
};

// Analyser les r√©sultats
const analyzeResults = (results) => {
  console.log('\nüìã Analyse d√©taill√©e des r√©sultats :');
  console.log('====================================');

  let totalTests = 0;
  let successfulTests = 0;
  let failedTests = 0;

  Object.entries(results).forEach(([apiName, apiResults]) => {
    console.log(`\nüîç ${apiName.toUpperCase()}:`);
    
    Object.entries(apiResults).forEach(([operation, result]) => {
      totalTests++;
      if (result.success) {
        successfulTests++;
        console.log(`  ‚úÖ ${operation}: OK`);
      } else {
        failedTests++;
        console.log(`  ‚ùå ${operation}: √âCHEC`);
        if (result.error) {
          console.log(`     Erreur: ${result.error}`);
        }
      }
    });
  });

  console.log('\nüìä Statistiques globales :');
  console.log('==========================');
  console.log(`Total des tests: ${totalTests}`);
  console.log(`Tests r√©ussis: ${successfulTests} (${((successfulTests/totalTests)*100).toFixed(1)}%)`);
  console.log(`Tests √©chou√©s: ${failedTests} (${((failedTests/totalTests)*100).toFixed(1)}%)`);

  // V√©rifier les APIs critiques
  const criticalAPIs = ['users', 'processes', 'documents', 'entities', 'categories', 'statuses'];
  const criticalWorking = criticalAPIs.filter(api => 
    results[api] && results[api].get && results[api].get.success
  );

  console.log(`\nüéØ APIs critiques fonctionnelles: ${criticalWorking.length}/${criticalAPIs.length}`);
  
  if (criticalWorking.length === criticalAPIs.length) {
    console.log('üéâ Toutes les APIs critiques fonctionnent parfaitement !');
  } else {
    const missingCritical = criticalAPIs.filter(api => 
      !results[api] || !results[api].get || !results[api].get.success
    );
    console.log(`‚ö†Ô∏è  APIs critiques avec probl√®mes: ${missingCritical.join(', ')}`);
  }

  return { totalTests, successfulTests, failedTests, criticalWorking: criticalWorking.length };
};

// Test de performance
const testPerformance = async () => {
  console.log('\n‚ö° Test de performance :');
  console.log('========================');

  const apis = [
    'https://v0-process-management-platform.vercel.app/api/users',
    'https://v0-process-management-platform.vercel.app/api/processes',
    'https://v0-process-management-platform.vercel.app/api/documents',
    'https://v0-process-management-platform.vercel.app/api/entities',
    'https://v0-process-management-platform.vercel.app/api/categories',
    'https://v0-process-management-platform.vercel.app/api/statuses',
    'https://v0-process-management-platform.vercel.app/api/reports',
    'https://v0-process-management-platform.vercel.app/api/access-logs',
    'https://v0-process-management-platform.vercel.app/api/permissions'
  ];

  const performanceResults = [];

  for (const api of apis) {
    const startTime = Date.now();
    try {
      const response = await fetch(api);
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      performanceResults.push({
        api: api.split('/').pop(),
        duration: duration,
        status: response.status,
        success: response.ok
      });
      
      const status = response.ok ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${api.split('/').pop()}: ${duration}ms (${response.status})`);
    } catch (error) {
      console.log(`‚ùå ${api.split('/').pop()}: Erreur - ${error.message}`);
    }
  }

  const avgDuration = performanceResults.reduce((sum, result) => sum + result.duration, 0) / performanceResults.length;
  console.log(`\nüìä Temps de r√©ponse moyen: ${avgDuration.toFixed(0)}ms`);
  
  return performanceResults;
};

// Fonction principale
const main = async () => {
  try {
    console.log('üöÄ D√©marrage de la v√©rification compl√®te...\n');
    
    // Test des APIs
    const results = await testAllAPIs();
    
    // Analyse des r√©sultats
    const analysis = analyzeResults(results);
    
    // Test de performance
    const performance = await testPerformance();
    
    console.log('\nüèÅ R√âSUM√â FINAL :');
    console.log('================');
    
    if (analysis.failedTests === 0) {
      console.log('üéâ PARFAIT ! Toutes les APIs fonctionnent parfaitement !');
      console.log('‚úÖ 100% de r√©ussite sur tous les tests');
    } else if (analysis.failedTests <= 2) {
      console.log('‚úÖ EXCELLENT ! Presque toutes les APIs fonctionnent parfaitement !');
      console.log(`‚úÖ ${analysis.successfulTests}/${analysis.totalTests} tests r√©ussis`);
    } else if (analysis.failedTests <= 5) {
      console.log('‚ö†Ô∏è  BON ! La plupart des APIs fonctionnent, quelques am√©liorations possibles.');
      console.log(`‚úÖ ${analysis.successfulTests}/${analysis.totalTests} tests r√©ussis`);
    } else {
      console.log('‚ùå ATTENTION ! Plusieurs APIs ont des probl√®mes.');
      console.log(`‚ùå ${analysis.failedTests}/${analysis.totalTests} tests √©chou√©s`);
    }
    
    console.log(`\nüéØ APIs critiques: ${analysis.criticalWorking}/6`);
    console.log(`‚ö° Performance: ${performance.length} APIs test√©es`);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la v√©rification:', error.message);
  }
};

// Ex√©cuter
main();
